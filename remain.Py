import telebot
import time
import json
import os
from threading import Thread
from telebot.apihelper import ApiTelegramException

# --- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ---
TOKEN = '8445157524:AAF8oTwxP9MLk6hf4h5YzghwvREjCreSuy4'
ADMIN_ID = 5971999624  # ğŸ‘ˆ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ù†Ø§
bot = telebot.TeleBot(TOKEN)

DATA_FILE = 'database.json'

# Ø¯Ø§Ù„Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù…Ù„Ù
def load_data():
    if os.path.exists(DATA_FILE):
        try:
            with open(DATA_FILE, 'r') as f:
                return json.load(f)
        except:
            return {}
    return {}

# Ø¯Ø§Ù„Ø© Ù„Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
def save_data():
    with open(DATA_FILE, 'w') as f:
        json.dump(active_chats, f)

active_chats = load_data()

# --- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ---
@bot.message_handler(commands=['admin'])
def admin_panel(message):
    if message.from_user.id == ADMIN_ID:
        markup = telebot.types.ReplyKeyboardMarkup(resize_keyboard=True)
        markup.add("ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª", "ğŸ“¢ Ø¥Ø°Ø§Ø¹Ø© Ø±Ø³Ø§Ù„Ø©")
        bot.reply_to(message, "ğŸ›  **Ø£Ù‡Ù„Ø§Ù‹ ÙŠØ§ Ù…Ø§Ù„Ùƒ Ø§Ù„Ø¨ÙˆØª.. Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¬Ø§Ù‡Ø²Ø©:**", reply_markup=markup)
    else:
        bot.reply_to(message, "âŒ Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·.")

@bot.message_handler(func=lambda m: m.from_user.id == ADMIN_ID and m.text == "ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª")
def stats(message):
    bot.reply_to(message, f"ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ø§ØªØ§Øª Ø§Ù„Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹: {len(active_chats)}")

@bot.message_handler(func=lambda m: m.from_user.id == ADMIN_ID and m.text == "ğŸ“¢ Ø¥Ø°Ø§Ø¹Ø© Ø±Ø³Ø§Ù„Ø©")
def broadcast_prompt(message):
    msg = bot.send_message(message.chat.id, "ğŸ’¬ Ø£Ø±Ø³Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø¥Ø°Ø§Ø¹ØªÙ‡Ø§ Ù„Ù„Ø¬Ù…ÙŠØ¹:")
    bot.register_next_step_handler(msg, perform_broadcast)

def perform_broadcast(message):
    count = 0
    for chat_id in list(active_chats.keys()):
        try:
            bot.send_message(chat_id, f"ğŸ“¢ **Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©:**\n\n{message.text}")
            count += 1
            time.sleep(0.2)
        except:
            pass
    bot.reply_to(message, f"âœ… ØªÙ…Øª Ø§Ù„Ø¥Ø°Ø§Ø¹Ø© Ø¨Ù†Ø¬Ø§Ø­ Ù„Ù€ {count} Ù…Ø³ØªØ®Ø¯Ù…/Ø¬Ø±ÙˆØ¨.")

# --- Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ---
@bot.message_handler(commands=['start'])
def start(message):
    msg = bot.reply_to(message, "Ù‚Ù… Ø¨ØªØ­Ø¯ÙŠØ¯ ÙˆÙ‚Øª Ø§Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ( Ø§Ù„Ø­Ø¯ Ø§Ù„Ø§Ø¯Ù†ÙŠ 1 Ø¯Ù‚ÙŠÙ‚Ù‡ Ùˆ Ø§Ù„Ø§Ù‚ØµÙŠ 3 Ø³Ø§Ø¹Ø§Øª)")
    bot.register_next_step_handler(msg, set_timer)

def set_timer(message):
    try:
        minutes = int(message.text)
        if 1 <= minutes <= 180:
            active_chats[str(message.chat.id)] = {'interval': minutes * 60, 'last_sent': time.time()}
            save_data()
            bot.reply_to(message, f"âœ… ØªÙ… Ø§Ù„Ø¶Ø¨Ø· Ø¨Ù†Ø¬Ø§Ø­! Ø³Ø£Ù‚ÙˆÙ… Ø¨Ø§Ù„ØªØ°ÙƒÙŠØ± ÙƒÙ„ {minutes} Ø¯Ù‚ÙŠÙ‚Ø© ï·º.")
        else:
            bot.reply_to(message, "âš ï¸ Ø®Ø·Ø£: ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„ÙˆÙ‚Øª Ø¨ÙŠÙ† 1 Ùˆ 180 Ø¯Ù‚ÙŠÙ‚Ø©.")
    except:
        bot.reply_to(message, "âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø· (Ù…Ø«Ù„Ø§Ù‹: 5).")

@bot.message_handler(commands=['stop'])
def stop(message):
    if str(message.chat.id) in active_chats:
        del active_chats[str(message.chat.id)]
        save_data()
        bot.reply_to(message, "ğŸ›‘ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ°ÙƒÙŠØ±.")
    else:
        bot.reply_to(message, "Ø§Ù„Ø¨ÙˆØª ØºÙŠØ± Ù…ÙØ¹Ù„ Ù‡Ù†Ø§.")

# --- Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ°ÙƒÙŠØ± Ø§Ù„Ù…Ø³ØªÙ‚Ø± ---
def remind_logic():
    while True:
        current_time = time.time()
        for chat_id, data in list(active_chats.items()):
            if current_time - data['last_sent'] >= data['interval']:
                try:
                    bot.send_message(chat_id, "ØµÙ„ÙŠ Ø¹Ù„ÙŠ Ø§Ù„Ù†Ø¨ÙŠ ï·º Ù…Ø´ Ø´Ø±Ø· ØªÙƒØªØ¨ ØµÙ„ÙŠ Ù Ø³Ø±Ùƒ")
                    active_chats[chat_id]['last_sent'] = current_time
                    save_data()
                except ApiTelegramException as e:
                    if e.error_code in [403, 400]:
                        if chat_id in active_chats:
                            del active_chats[chat_id]
                            save_data()
                except:
                    pass
        time.sleep(15)

Thread(target=remind_logic, daemon=True).start()

# ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª Ù…Ø¹ Ù†Ø¸Ø§Ù… Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„ØªÙˆÙ‚Ù
print("Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù†...")
while True:
    try:
        bot.polling(none_stop=True, interval=2, timeout=20)
    except Exception as e:
        print(f"Polling error: {e}")
        time.sleep(5)
