import telebot
import time
from threading import Thread

# --- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ---
TOKEN = '8445157524:AAF8oTwxP9MLk6hf4h5YzghwvREjCreSuy4'
ADMIN_ID = 123456789  # ğŸ‘ˆ Ø¶Ø¹ ID Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù‡Ù†Ø§
bot = telebot.TeleBot(TOKEN)

# ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª {chat_id: {interval: seconds, last_sent: timestamp}}
active_chats = {}

# --- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·) ---
@bot.message_handler(commands=['admin'])
def admin_panel(message):
    if message.from_user.id == ADMIN_ID:
        markup = telebot.types.ReplyKeyboardMarkup(resize_keyboard=True)
        markup.add("ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª", "ğŸ“¢ Ø¥Ø°Ø§Ø¹Ø© Ø±Ø³Ø§Ù„Ø©")
        bot.reply_to(message, "ğŸ›  **Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø§Ù„Ùƒ**", reply_markup=markup)
    else:
        bot.reply_to(message, "âŒ Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± Ù…Ø®ØµØµ Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·.")

@bot.message_handler(func=lambda message: message.from_user.id == ADMIN_ID and message.text in ["ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª", "ğŸ“¢ Ø¥Ø°Ø§Ø¹Ø© Ø±Ø³Ø§Ù„Ø©"])
def handle_admin(message):
    if message.text == "ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª":
        bot.reply_to(message, f"ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ø§ØªØ§Øª Ø§Ù„Ù†Ø´Ø·Ø©: {len(active_chats)}")
    elif message.text == "ğŸ“¢ Ø¥Ø°Ø§Ø¹Ø© Ø±Ø³Ø§Ù„Ø©":
        msg = bot.send_message(message.chat.id, "ğŸ’¬ Ø£Ø±Ø³Ù„ Ù†Øµ Ø§Ù„Ø¥Ø°Ø§Ø¹Ø© Ø§Ù„Ø¢Ù†:")
        bot.register_next_step_handler(msg, perform_broadcast)

def perform_broadcast(message):
    count = 0
    for chat_id in list(active_chats.keys()):
        try:
            bot.send_message(chat_id, f"ğŸ“¢ **ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ø§Ù…:**\n\n{message.text}")
            count += 1
        except: pass
    bot.reply_to(message, f"âœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ {count} Ø´Ø§Øª.")

# --- Ø£Ù…Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ ---
@bot.message_handler(commands=['start'])
def start(message):
    # Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ØªÙ…Ø§Ù…Ø§Ù‹
    msg = bot.reply_to(message, "Ù‚Ù… Ø¨ØªØ­Ø¯ÙŠØ¯ ÙˆÙ‚Øª Ø§Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ( Ø§Ù„Ø­Ø¯ Ø§Ù„Ø§Ø¯Ù†ÙŠ 1 Ø¯Ù‚ÙŠÙ‚Ù‡ Ùˆ Ø§Ù„Ø§Ù‚ØµÙŠ 3 Ø³Ø§Ø¹Ø§Øª)")
    bot.register_next_step_handler(msg, set_timer)

def set_timer(message):
    try:
        minutes = int(message.text)
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ ÙˆØ§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ (3 Ø³Ø§Ø¹Ø§Øª = 180 Ø¯Ù‚ÙŠÙ‚Ø©)
        if minutes < 1:
            bot.reply_to(message, "âš ï¸ Ø®Ø·Ø£: Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù‡Ùˆ 1 Ø¯Ù‚ÙŠÙ‚Ø©. Ø£Ø±Ø³Ù„ /start Ù„Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.")
            return
        if minutes > 180:
            bot.reply_to(message, "âš ï¸ Ø®Ø·Ø£: Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù‡Ùˆ 3 Ø³Ø§Ø¹Ø§Øª (180 Ø¯Ù‚ÙŠÙ‚Ø©). Ø£Ø±Ø³Ù„ /start Ù„Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.")
            return
        
        active_chats[message.chat.id] = {
            'interval': minutes * 60,
            'last_sent': time.time()
        }
        bot.reply_to(message, f"âœ… ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙˆÙ‚Øª Ø¨Ù†Ø¬Ø§Ø­ ÙƒÙ„ {minutes} Ø¯Ù‚ÙŠÙ‚Ø© ï·º.\nÙ„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ°ÙƒÙŠØ± Ø£Ø±Ø³Ù„ /stop")
        
    except ValueError:
        bot.reply_to(message, "âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·. Ø£Ø±Ø³Ù„ /start Ù„Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.")

# --- Ø£Ù…Ø± Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù ---
@bot.message_handler(commands=['stop'])
def stop(message):
    if message.chat.id in active_chats:
        del active_chats[message.chat.id]
        bot.reply_to(message, "ğŸ›‘ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ°ÙƒÙŠØ± Ø¨Ù†Ø¬Ø§Ø­.")
    else:
        bot.reply_to(message, "Ø§Ù„Ø¨ÙˆØª ØºÙŠØ± Ù…ÙØ¹Ù„ Ù„Ø¯ÙŠÙƒ.")

# --- Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ°ÙƒÙŠØ± ---
def remind_logic():
    while True:
        current_time = time.time()
        for chat_id in list(active_chats.keys()):
            data = active_chats[chat_id]
            if current_time - data['last_sent'] >= data['interval']:
                try:
                    bot.send_message(chat_id, "ØµÙ„ÙŠ Ø¹Ù„ÙŠ Ø§Ù„Ù†Ø¨ÙŠ ï·º Ù…Ø´ Ø´Ø±Ø· ØªÙƒØªØ¨ ØµÙ„ÙŠ Ù Ø³Ø±Ùƒ")
                    active_chats[chat_id]['last_sent'] = current_time
                except:
                    if chat_id in active_chats: del active_chats[chat_id]
        time.sleep(10)

Thread(target=remind_logic, daemon=True).start()

print("Ø§Ù„Ø¨ÙˆØª Ø´ØºØ§Ù„...")
bot.infinity_polling()
